name: "CD: facilitator (all)"

on:
  push:
    branches:
    - 'master'
    - 'deploy-facilitator-prod'
    - 'COM-633'

jobs:
  deploy:
    env:
      AWS_ACCESS_KEY_ID:  ${{ secrets.DEPLOYMENT_AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY:  ${{ secrets.DEPLOYMENT_AWS_SECRET_ACCESS_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./facilitator
    steps:
      - id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PEM }}
          owner: ${{ github.repository_owner }}
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set deployment environment
        id: set-env
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/master" ]] || [[ "${GITHUB_REF}" == "refs/heads/COM-633" ]]; then
            echo "env=staging" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == "refs/heads/deploy-facilitator-prod" ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch: ${GITHUB_REF}"
            exit 1
          fi
      - name: Deploy to AWS
        run: ./deploy-to-aws.sh ${{ steps.set-env.outputs.env }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create deployment tag
        run: |
          git tag "deployed-facilitator-${{ steps.set-env.outputs.env }}-$(date +%Y%m%d-%H%M%S)"
          git push origin "deployed-facilitator-${{ steps.set-env.outputs.env }}-$(date +%Y%m%d-%H%M%S)"
